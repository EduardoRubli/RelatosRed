<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/estilos.css">
  <title>Relatosfera</title>
</head>
<body>
<div class="contenedor-principal">
<header class="header-container">
  <div class="header-inner">
    <h1 class="header-titulo">
      <a href="/index" class="header-link">Relatosfera</a>
    </h1>
    <div class="header-login" id="headerLogin">
      <!-- El login se cargará aquí -->
    </div>
  </div>
</header>

<section id="filtrosContainer">
  <form id="filtrarCategoriaForm" class="bloque-filtro">
    <select id="categoriaSelect" name="categoria">
      <option value="">-- Categoría --</option>
    </select>
    <label for="criterioSelect">Orden:</label>
    <select id="criterioSelect" name="criterio">
      <option value="notaMedia">Nota Media</option>
      <option value="fechaPublicacionD">Fecha Descendente</option>
      <option value="fechaPublicacionA">Fecha Ascendente</option>
    </select>
    <button type="submit">Filtrar</button>
  </form>
  <form id="buscarTextosForm" class="bloque-filtro">
    <input type="text" id="subcadenaTextos" name="subcadena" placeholder="Buscar por título o autor..." required>
    <button type="submit">Buscar</button>
  </form>
</section>

<main>
  <section id="resultadosContainer"></section>
</main>

<footer>
  &copy; 2025 Relatosfera.
</footer>
</div>
<script>
  const BASE_URL = 'http://localhost:8080';

  let idTextoActual = null;
  let usuarioActual = null;
  // Flag para control de instancias.
  let instanciaActual  = 'resultados';
  let instanciaAnterior = null;
  // ID de usuario del último perfil.
  let ultimoPerfilVisitado = null;

  // Obtenemos usuario actual.
  function obtenerUsuarioActual() {
    return fetch('/usuario/me')
            .then(resp => resp.ok ? resp.json() : Promise.reject('No autenticado'))
            .then(data => {
              usuarioActual = data;
              cargarLogin();
              return data;
            });
  }

  function capitalizar(str) {
    return str.replace(/\b\w/g, c => c.toUpperCase());
  }

  function procesarCategoria(categoria){
    categoria = capitalizar(categoria.toLowerCase());
    if (categoria === 'Cienciafic') categoria = 'Ciencia Ficción';

    return categoria;
  }

  function cargarLogin() {
    const headerLogin = document.getElementById('headerLogin');
    if (!headerLogin) return;

    var saludo = 'Bienvenido';
    if (usuarioActual && usuarioActual.sexo === 'femenino') {
      saludo = 'Bienvenida';
    }

    if (usuarioActual) {
      headerLogin.innerHTML = `
      <span class="bienvenida">${saludo}, ${capitalizar(usuarioActual.alias)}</span>
      <div class="login-links">
        <b><a href="#" class="link-registro">Condiciones generales</a>
        <a href="/logout" class="link-registro" style="color: #f16161">Logout</a></b>
      </div>`;
    } else {
      headerLogin.innerHTML = `
      <form class="form-login-linea" action="/index" method="post">
        <input type="email" id="emailLogin" placeholder="Email" name="email" required>
        <input type="password" id="passwordLogin" placeholder="Contraseña" name="password" required>
        <button class="login-btn" id="loginBtn" type="submit">Login</button>
      </form>
      <div class="login-links">
        <a href="#" class="link-registro">Condiciones generales</a>
        <a href="/registro" class="link-registro">Registrar usuario</a>
        <a href="/index" class="link-registro">Inicio</a>
      </div>
      `;
    }
  }

  // --- Vista de texto ---
  // Obtener parámetro de la URL.
  function getParameterByName(name) {
    const url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
    const results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
  }

  function volver() {

    if (instanciaActual === 'texto' && instanciaAnterior === 'perfil' && ultimoPerfilVisitado) {
      cargarPerfilUsuario(ultimoPerfilVisitado)
    } else if (instanciaActual === 'texto') {
      volverALista()
    } else {
      if (typeof idTextoActual === "undefined" || !idTextoActual) {
        window.location.href = "/index";
      } else {
        cargarDetalleTexto(idTextoActual)
      }
    }
  }

  function mostrarFeedback(mensaje) {
    const contenedor = document.getElementById('resultadosContainer');
    const textoAMostrar = mensaje || "Operación realizada con éxito.";
    contenedor.innerHTML = `
        <div class="ventana-error">
            <div class="titulo-error">Mensaje informativo:</div>
            <div class="error-mensaje">
                <p>✅ ${textoAMostrar}</p>
                <button onclick="volver()">Volver</button>
            </div>
        </div>`;
  }

  function mostrarError(mensaje) {
    const contenedor = document.getElementById('resultadosContainer');
    const textoAMostrar = mensaje || "No se pudo cargar el texto.";
    contenedor.innerHTML = `
        <div class="ventana-error">
            <div class="titulo-error">Se ha producido un error:</div>
            <div class="error-mensaje">
                <p>⚠️ ${textoAMostrar}</p>
                <button onclick="volver()">Volver</button>
            </div>
        </div>`;
  }

  function mostrarErrorComentarios(mensaje) {
    const contenedor = document.getElementById('comentariosContainer');
    const textoAMostrar = mensaje || "No se pudieron cargar los comentarios.";
    contenedor.innerHTML = `
        <div class="ventana-error">
            <div class="titulo-error">Se ha producido un error:</div>
            <div class="error-mensaje">
                <p>⚠️ ${textoAMostrar}</p>
            </div>
        </div>`;
  }

  // Función para validar idTexto.
  function validarIdTexto(idTexto) {
    if (!/^\d+$/.test(idTexto)) {
      throw new Error('ID incorrecto: solo números permitidos.');
    }
    const idNum = parseInt(idTexto);
    if (idNum <= 0 || isNaN(idNum)) {
      throw new Error('ID incorrecto: valor fuera de rango.');
    }
    return idNum;
  }

  function cargarDetalleTexto(idTexto) {
    let idNum;
    try {
      idNum = validarIdTexto(idTexto);
    } catch (error) {
      mostrarError(error.message);
      return;
    }

    fetch(`/texto/${idTexto}`)
            .then(response => {
              if (!response.ok) throw new Error("No se encontró el texto.");
              return response.json();
            })
            .then(mostrarDetalleTexto)
            .catch(error => {
              mostrarError(error.message || 'Error al cargar el texto.');
            });
  }

  // Carga parcial de comentarios.
  function cargarComentarios(idTexto) {
    fetch(`/texto/${idTexto}/comentarios`)
            .then(resp => {
              if (!resp.ok) throw new Error(`Error ${resp.status}: No se pudieron cargar los comentarios`);
              return resp.json();
            })
            .then(mostrarComentarios)
            .catch(() => mostrarErrorComentarios("No se pudieron cargar los comentarios."));
  }

  // Función para enviar comentarios.
  function enviarComentario(idTexto) {
    const contenido = document.getElementById('inputComentario').value.trim();
    const notificar = document.getElementById('notificarRespuesta').checked;
    const titulo = "Comentario de usuario"; // O puedes pedirlo en otro input

    if (!contenido) {
      alert("El comentario no puede estar vacío.");
      return;
    }

    if (!usuarioActual || !usuarioActual.idUsuario) {
      alert("Debes iniciar sesión para comentar.");
      return;
    }

    const params = new URLSearchParams();
    params.append('contenidoStr', contenido);
    params.append('idEmisor', usuarioActual.idUsuario);
    params.append('tipoStr', 'COMENTARIO');
    params.append('idTexto', idTexto);
    params.append('tituloStr', titulo);
    // No hace falta idPadre ni idReceptor para comentarios raíz

    fetch('/mensaje', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params
    })
            .then(resp => {
              if (!resp.ok) throw new Error('Error al enviar comentario');
              return resp.json();
            })
            .then(mensajeCreado => {
              // Limpia el input
              document.getElementById('inputComentario').value = '';
              // Opcional: recarga los comentarios
              //cargarComentarios(idTexto);
              alert('Comentario publicado.');
            })
            .catch(error => {
              alert('No se pudo enviar el comentario: ' + error.message);
            });
  }

  async function guardarTexto(idTexto) {
    try {
      // Comprueba que el PDF está disponible
      const head = await fetch(`/texto/${idTexto}/pdf`, {
        method: 'HEAD',
        credentials: 'include'
      });
      if (!head.ok) throw new Error(`Código ${head.status}`);

      // Lanza la descarga en nueva pestaña
      window.open(`/texto/${idTexto}/pdf`, '_blank');
    } catch (e) {
      console.error('Error al descargar PDF:', e);
      alert('No se pudo descargar el PDF: ' + e.message);
    }
  }

  function inyectarMenuUsuario(usuarioActual, texto){
    if (!usuarioActual) return '';

    // Verificar si el usuario es autor para mostrar editar
    const esAutor = usuarioActual.idUsuario === texto.autor?.idUsuario;

    return `
    <nav class="nav-usuario">
      <button class="nav-usuario-boton" onclick="cargarPerfilUsuario(usuarioActual.idUsuario)">
        <i class="fas fa-user"></i>
        <span>Mi Perfil</span>
      </button>
      <button class="nav-usuario-boton" onClick="mostrarFormularioCreacion()">
        <i class="fas fa-plus-circle"></i>
        <span>Crear</span>
      </button>
      ${esAutor ? `
        <button class="nav-usuario-boton" onclick="mostrarFormularioEdicion(${texto.idTexto})">
             <i class="fas fa-edit"></i>
             <span>Editar</span>
        </button>
      ` : ''}
        <button class="nav-usuario-boton" onclick="mostrarFormPuntuacion()">
            <i class="fas fa-star"></i>
            <span>Puntuar</span>
        </button>
      <button class="nav-usuario-boton" onclick="guardarTexto(${texto.idTexto})">
        <i class="fas fa-bookmark"></i>
        <span>Guardar</span>
      </button>
    </nav>
  `;
  }

  function volverALista() {
    // Restauramos estado anterior.
    [ listaTextos, listaTextosAnterior ] = [ listaTextosAnterior, listaTextos ];
    [ paginaActual, paginaAnterior ] = [ paginaAnterior, paginaActual ];

    // Reconstruimos la vista.
    initPaginacion(listaTextos);
  }

  function mostrarDetalleTexto(texto) {
    // Seteamos flags.
    instanciaAnterior = instanciaActual;
    instanciaActual  = 'texto';

    // Elimina la paginación si estaba ahí.
    const pag = document.getElementById('paginacion')
    if (pag) pag.remove()

    listaTextosAnterior = [...listaTextos];
    paginaAnterior = paginaActual;
    // Obtenemos idTexto actual.
    idTextoActual = texto.idTexto;

    const categoria = texto.categoria?.categoria ?? 'Sin categoría';
    const subcategoria = texto.categoria?.subcategoria ?? '';
    const categoriaCompleta = subcategoria
            ? `${categoria} > ${subcategoria}`
            : categoria;
    const fecha = formatearFecha(texto.fechaPublicacion);

    const container = document.getElementById('resultadosContainer');

    let cajaComentario = '';
    if (usuarioActual) {
      cajaComentario = `
    <div class="comentario-barra-outer">
      <div class="comentario-barra-inner">
        <textarea
          id="inputComentario"
          placeholder="Escribe un comentario..."
          rows="2"
          maxlength="300"
          class="comentario-textarea"></textarea>
        <div class="comentario-opciones">
          <label class="comentario-check-label">
            <button id="enviarComentarioBtn" class="comentario-boton">Enviar</button>
            <input type="checkbox" id="notificarRespuesta" />
            Notificarme cuando haya respuestas.
          </label>
        </div>
      </div>
    </div>
  `;
    }

    container.innerHTML = `
        ${inyectarMenuUsuario(usuarioActual, texto)}
        <div class="detalle-relato-cabecera">
        <h2 class="detalle-relato-titulo">${texto.titulo}</h2>
        <div class="puntuacion-wrapper">
            <form id="puntuacionForm" class="puntuacion-form" style="display: none;">
                <div class="puntuacion-input-group">
                    <input type="number"
                           name="nota"
                           min="1"
                           max="10"
                           step="0.5"
                           placeholder="1-10"
                           required
                           class="puntuacion-input">
                    <button type="submit" class="puntuacion-btn">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </form>
            <div class="detalle-relato-nota-container">
                 <button class="btn-volver" onclick="volver()">
                    <i class="fas fa-arrow-left"></i>
                 </button>
                <span class="detalle-relato-nota">${texto.notaMedia?.toFixed(1) || 's/n'}</span>
            </div>
        </div>
        </div>
        <div class="detalle-relato-meta">
            <div class="meta-izq">
                <strong>Categoria: </strong>${procesarCategoria(categoria)}
            </div>
            <div class="meta-centro">
                <strong>Autor: </strong>
                <a href="#" onclick="cargarPerfilUsuario(${texto.autor.idUsuario})" class="detalle-relato-autor" style="color: #314173;">
                    ${texto.autor.nombre} ${texto.autor.apellido}
                </a>
            </div>
            <div class="meta-der">
                <strong>Fecha: </strong>${fecha}
            </div>
        </div>
        <div class="detalle-relato-contenido">
            ${texto.contenido.replace(/\n/g, '<br>')}
        </div>
        <br>
        ${cajaComentario}
        <div class="comentariosContainer" id="comentariosContainer"></div>
    `;
    // Configuramos eventos para puntuación.
    configurarPuntuacion(texto.idTexto);
    // Evita error si no hay usuario logueado.
    const btnEnviar = document.getElementById('enviarComentarioBtn')
    // En el evento onClick enviamos mensaje.
    if (btnEnviar) {
      btnEnviar.onclick = () => enviarComentario(texto.idTexto)
    }

    fetch(`/texto/${texto.idTexto}/comentarios`)
            .then(resp => {
              if (!resp.ok) {
                throw new Error(`Error ${resp.status}: No se pudieron cargar los comentarios`);
              }
              return resp.json();
            })
            .then(mostrarComentarios)
            .catch(error => mostrarErrorComentarios("No se pudieron cargar los comentarios."));
  }

  function eliminarComentario(idMensaje) {
    fetch(`/mensaje/${idMensaje}/eliminar`, { method: 'PUT'})
      .then(resp => {
        if (!resp.ok) throw new Error('No se pudo eliminar el comentario');
        return resp.text();
      })
      .then(() => { cargarComentarios(idTextoActual);
      })
      .catch(err => mostrarErrorComentarios('No se pudo eliminar el comentario.'));
  }

  // Mostrar comentarios de un texto.
  function mostrarComentarios(comentarios) {
    const contenedor = document.getElementById('comentariosContainer');
    contenedor.innerHTML = '';

    if (usuarioActual && (!Array.isArray(comentarios) || comentarios.length === 0)) {
      contenedor.innerHTML = '<div class="sin-comentariosLog"">Sin comentarios por ahora.</div>';
      return;
    } else if (!Array.isArray(comentarios) || comentarios.length === 0) {
      contenedor.innerHTML = '<div class="sin-comentarios">Sin comentarios por ahora.</div>';
      return;
    }

    comentarios.forEach(mensaje => {
      // Solo mostramos comentarios raíz (tipo COMENTARIO)
      if (mensaje.tipo !== "COMENTARIO" && mensaje.tipo !== "RESCOMENTARIO") return;

      // Formatea la fecha
      const fecha = formatearFecha(mensaje.fechaEnvio);

      // Verifica si puede eliminar este comentario
      let puedeEliminar = usuarioActual &&
              (mensaje.emisor?.idUsuario === usuarioActual.idUsuario ||
                      usuarioActual.rol === "ADMIN" || usuarioActual.rol === "MODERADOR");

      // Monta el bloque HTML
      const comentarioDiv = document.createElement('div');
      comentarioDiv.className = 'comentario-card';

      comentarioDiv.innerHTML = `
      <div class="comentario-titulo">${mensaje.titulo || '(Sin título)'}</div>
      <div class="comentario-meta">
        <span class="comentario-autor">
          <a href="#" onclick="cargarPerfilUsuario(${mensaje.emisor?.idUsuario})">
            ${`${mensaje.emisor?.nombre || ''} ${mensaje.emisor?.apellido || ''}`.trim() || 'Usuario'}
          </a>
        </span>
        <span class="comentario-fecha">${fecha}</span>
      </div>
      <div class="comentario-mensaje">
        ${mensaje.contenido}
      </div>
      ${usuarioActual ? `
        <div class="comentario-acciones">
            <button class="btn-responder" disabled>Responder</button>
            ${
              puedeEliminar
                      ? `<button class="btnEliminarComentario" data-id="${mensaje.idMensaje}">
              Eliminar</button>`
                      : ''
            }
        </div>
        ` : ''}
      `;
      contenedor.appendChild(comentarioDiv);
    });

    // Asocia el evento a todos los botones eliminar.
    document.querySelectorAll('.btnEliminarComentario').forEach(btn => {
      btn.onclick = function() {
        const idMensaje = this.getAttribute('data-id');
        if (confirm('¿Quieres eliminar este comentario?')) {
          eliminarComentario(idMensaje);
        }
      };
    });
  }

  // --- PRINCIPAL ---
  // Obtener autor.
  const cacheAutores = {};
  async function obtenerNombreAutor(idAutor) {
    if (cacheAutores[idAutor]) return cacheAutores[idAutor];
    try {
      const res = await fetch(`${BASE_URL}/usuario/${idAutor}`);
      if (!res.ok) return 'Autor desconocido';
      const usuario = await res.json();
      const nombreCompleto = usuario.alias || (usuario.nombre + ' ' + usuario.apellido);
      cacheAutores[idAutor] = nombreCompleto;
      return nombreCompleto;
    } catch {
      return 'Autor desconocido';
    }
  }

  // Formateo de fecha (2025-05-12T22:51:58).
  function formatearFecha(fechaStr) {
    if (!fechaStr) return '';
    const fecha = new Date(fechaStr);
    const opciones = { day: '2-digit', month: '2-digit', year: 'numeric' };
    return fecha.toLocaleDateString('es-ES', opciones);
  }

  // --- PAGINACIÓN ---
  let listaTextos = []
  const itemsPorPagina = 6
  let paginaActual = 1
  // Lista de textos guardada.
  let listaTextosAnterior = []
  let paginaAnterior = 1

  // Llama a mostrarResultados().
  function initPaginacion(textos) {
    // Seteamos flags.
    instanciaAnterior = instanciaActual;
    instanciaActual  = 'resultados';

    listaTextos = textos
    const totalPaginas = Math.ceil(textos.length / itemsPorPagina)
    renderPagControls(totalPaginas)
    mostrarResultados(textos, paginaActual)
  }

  // Crea los botones de paginación.
  function renderPagControls(totalPaginas) {
    // Si no hay resultados.
    if (totalPaginas <= 1) {
      // Elimina paginación si existe.
      const viejo = document.getElementById('paginacion');
      if (viejo) viejo.remove();
      return; // Sale de la función.
    }

    const pagContainer = document.createElement('div')
    pagContainer.id = 'paginacion'

    const anterior = document.createElement('button')
    anterior.textContent = '« Anterior'
    anterior.disabled = paginaActual === 1
    anterior.onclick = () => cambiarPagina(paginaActual - 1)
    pagContainer.appendChild(anterior)

    // Lógica para mostrar botones.
    const mostrarBoton = (i) => {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.disabled = i === paginaActual;
      btn.onclick = () => cambiarPagina(i);
      pagContainer.appendChild(btn);
    };

    // Rango a mostrar.
    let rango = 2;
    // Muestra la primera página.
    mostrarBoton(1);

    // Elipsis si hay hueco entre rango e inicio.
    if (paginaActual - rango > 2) {
      const elipsis = document.createElement('span');
      elipsis.textContent = ' ... ';
      pagContainer.appendChild(elipsis);
    }

    // Páginas cercanas a la actual.
    for (let i = Math.max(2, paginaActual - rango); i <= Math.min(totalPaginas - 1,
            paginaActual + rango); i++) {
      mostrarBoton(i);
    }

    // Elipsis si hay hueco entre rango y final.
    if (paginaActual + rango < totalPaginas - 1) {
      const elipsis = document.createElement('span');
      elipsis.textContent = ' ... ';
      pagContainer.appendChild(elipsis);
    }

    // Siempre muestra la última página.
    if (totalPaginas > 1) {
      mostrarBoton(totalPaginas);
    }

    const siguiente = document.createElement('button')
    siguiente.textContent = 'Siguiente »'
    siguiente.disabled = paginaActual === totalPaginas
    siguiente.onclick = () => cambiarPagina(paginaActual + 1)
    pagContainer.appendChild(siguiente)

    const main = document.querySelector('main')
    const viejo = document.getElementById('paginacion')
    if (viejo) viejo.replaceWith(pagContainer)
    else main.appendChild(pagContainer)
  }

  function cambiarPagina(nueva) {
    paginaActual = nueva
    // 'listaTextos` es el array original.
    mostrarResultados(listaTextos, paginaActual)
    renderPagControls(Math.ceil(listaTextos.length / itemsPorPagina))
  }

  // Mostrar lista de textos en tarjetas.
  async function mostrarResultados(textos, pagina = 1) {
    const inicio = (pagina - 1) * itemsPorPagina
    const fin    = inicio + itemsPorPagina
    const subconjunto = textos.slice(inicio, fin)

    const contenedor = document.getElementById('resultadosContainer');
    contenedor.innerHTML = '';

    if (!Array.isArray(textos) || textos.length === 0) {
      contenedor.innerHTML = `
        <div class="sin-resultados">
            <i class="fas fa-book-open"></i>
            <p>No se encontraron resultados.</p>
         </div>
        `;
      return;
    }

    // --- Div separador superior ---
    const separador = document.createElement('div');
    separador.style.height = '1em';
    separador.style.backgroundColor = '#f2eded';
    contenedor.appendChild(separador);

    // Carga asíncrona de autores por cada texto.
    for (const texto of subconjunto) {
      const div = document.createElement('div');
      div.classList.add('tarjeta-texto');

      // Formatea categoría
      const cat = texto.categoria ? texto.categoria.categoria : 'SIN CATEGORÍA';

      // Autor.
      let autor;
      if (texto.autor && (texto.autor.alias || texto.autor.nombre)) {
        autor = texto.autor.alias || (texto.autor.nombre + ' ' + texto.autor.apellido);
      } else if (texto.idAutor) {
        autor = await obtenerNombreAutor(texto.idAutor);
      } else {
        autor = 'Autor desconocido';
      }

      // Fecha.
      const fecha = formatearFecha(texto.fechaPublicacion);

      // Categoría, título, autor, fecha.
      const row = document.createElement('div');
      row.classList.add('texto-row');

      const spanCategoria = document.createElement('span');
      spanCategoria.className = 'texto-categoria';
      spanCategoria.textContent = cat;

      const spanTitulo = document.createElement('span');
      spanTitulo.className = 'texto-titulo';
      const tituloLink = document.createElement('a');
      tituloLink.textContent = texto.titulo || '(Sin título)';
      // Ojo a este enlace.
      tituloLink.href = '#'
      tituloLink.className = 'titulo-relato'
// al hacer click, previenes el salto de página y cargas el detalle
      tituloLink.addEventListener('click', function(e) {
        e.preventDefault()
        cargarDetalleTexto(texto.idTexto)
      })
      spanTitulo.appendChild(tituloLink)

      const spanAutor = document.createElement('span');
      spanAutor.className = 'texto-autor';
      spanAutor.textContent = autor;

      const spanFecha = document.createElement('span');
      spanFecha.className = 'texto-fecha';
      spanFecha.textContent = fecha;

      // Añadir los spans en orden
      row.appendChild(spanCategoria);
      row.appendChild(spanTitulo);
      row.appendChild(spanAutor);
      row.appendChild(spanFecha);

      // Solo agregas la fila, no el link suelto
      div.appendChild(row);

      // Sinopsis
      const sinopsis = document.createElement('div');
      sinopsis.classList.add('texto-sinopsis');
      sinopsis.textContent = texto.sinopsis || '(Sin sinopsis)';
      div.appendChild(sinopsis);

      contenedor.appendChild(div);
    }
  }

  // --- PETICIONES Y EVENTOS ---
  // Buscar textos por subcadena
  document.getElementById('buscarTextosForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const subcadena = document.getElementById('subcadenaTextos').value.trim();
    fetch(`${BASE_URL}/textos?subcadena=${encodeURIComponent(subcadena)}`)
            .then(resp => resp.json())
            .then(initPaginacion)
            .catch(err => alert('No se encontraron coincidencias.'));
    this.reset();
  });

  // Filtrar por categoría y criterio.
  document.getElementById('filtrarCategoriaForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const categoria = document.getElementById('categoriaSelect').value.trim();
    const criterio = document.getElementById('criterioSelect').value;
    if (!categoria) return alert('Selecciona una categoría');

    const params = new URLSearchParams({ categoria });
    if (criterio) params.append('criterio', criterio);

    fetch(`${BASE_URL}/textos?${params.toString()}`)
            .then(resp => resp.json())
            .then(initPaginacion)
            .catch(err => alert('No se pudo filtrar textos.'));
  });

  function cargarCategoriasFormulario() {
    fetch(`${BASE_URL}/categorias/subcategorias`)
            .then(response => response.json())
            .then(data => {
              const categoriaSelect = document.getElementById('categoria');
              const subcategoriaSelect = document.getElementById('subcategoria');

              // Cargar categorías principales
              data.categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoriaSelect.appendChild(option);
              });

              // Cargar todas las subcategorías al inicio
              subcategoriaSelect.innerHTML = '<option value="">Ninguna</option>';
              data.subcategorias.forEach(sub => {
                // Asume formato "CATEGORIA_SUBCATEGORIA".
                const subcat = sub.split('_')[1];
                const option = document.createElement('option');
                option.value = subcat;
                option.textContent = subcat;
                subcategoriaSelect.appendChild(option);
              });
            })
            .catch(error => console.error('Error:', error));
  }

  // Construir formulario para crear texto.
  function mostrarFormularioCreacion() {
    // Seteamos flags.
    instanciaAnterior = instanciaActual;
    instanciaActual   = 'formulario';

    document.getElementById('filtrosContainer').style.display = 'none';
    const container = document.getElementById('resultadosContainer');
    container.style.background = '#f2eded';
    container.innerHTML = `
    <div class="form-header">
        <button class="btn-volver-form" onclick="volver()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <i class="fas fa-plus-circle"></i> Crear Nuevo Texto
    </div>
    <div class="form-crear-container">
     <div class="form-inner-wrapper">
      <form id="crearTextoForm">
        <div class="form-group">
          <label for="titulo">Título:</label>
          <input type="text" id="titulo" name="titulo" required>
        </div>

        <div class="form-group">
          <label for="contenido">Contenido:</label>
          <textarea id="contenido" name="contenido" required></textarea>
        </div>

        <div class="form-dual-select">
          <div class="form-group">
            <label for="estado">Estado:</label>
            <select id="estado" name="estado" required>
              <option value="BORRADOR">Borrador</option>
              <option value="PUBLICADO">Publicar</option>
            </select>
          </div>

          <div class="form-group">
            <label for="idioma">Idioma:</label>
            <input type="text" id="idioma" name="idioma">
          </div>
        </div>

        <div class="form-dual-select">
          <div class="form-group">
            <label>Categoría:</label>
            <select id="categoria" name="categoria" required>
                <option value="MISTERIO">Misterio</option>
                <option value="THRILLER">Thriller</option>
                <option value="DRAMA">Drama</option>
                <option value="FANTASIA">Fantasía</option>
                <option value="CIENCIAFIC">Ciencia ficción</option>
                <option value="HISTORICO">Histórico</option>
                <option value="AVENTURA">Aventura</option>
                <option value="FANFIC">Fanfic</option>
                <option value="BIOGRAFIA">Biografía</option>
            </select>
          </div>

          <div class="form-group">
            <label>Subcategoría:</label>
            <select id="subcategoria" name="subcategoria">
                <option value="OPCIONAL">Ninguna</option>
                <option value="CRIMEN">Crimen</option>
                <option value="POLICIACO">Policiaco</option>
                <option value="ROMANCE">Romance</option>
                <option value="PSICOLOGICO">Psicológico</option>
                <option value="CONSPIRACION">Conspiración</option>
                <option value="FUTURISTA">Futurista</option>
                <option value="TERROR">Terror</option>
                <option value="PARANORMAL">Paranormal</option>
                <option value="JUVENIL">Juvenil</option>
                <option value="UTOPIA">Utopía</option>
                <option value="DISTOPIA">Distopía</option>
                <option value="BELICO">Bélico</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="sinopsis">Sinopsis:</label>
          <textarea id="sinopsis" name="sinopsis"></textarea>
        </div>

        <button type="submit" class="btn-submit">Publicar Texto</button>
      </form>
     </div>
    </div>
  `;
    configurarEnvioFormulario();
  }

  // Configurar envío del formulario (mejorado)
  function configurarEnvioFormulario() {
    document.getElementById('crearTextoForm')?.addEventListener('submit', function(e) {
      e.preventDefault();

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());
      data.idAutor = usuarioActual.idUsuario;

      // Convertir subcategoría vacía a null.
      if (data.subcategoria === "OPCIONAL") {
        data.subcategoria = null;
      }

      // Convertir a URLSearchParams (para enviar como x-www-form-urlencoded)
      const params = new URLSearchParams();
      for (const key in data) {
        params.append(key, data[key]);
      }

      // Enviar datos al backend
      fetch(`${BASE_URL}/texto`, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: params
      })
              .then(response => {
                if (!response.ok) {
                  return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
              })
              .then(textoCreado => {
                mostrarFeedback('Texto creado correctamente.');
                // No existe el id antes de crearlo.
                const idTexto = textoCreado.idTexto;
                setTimeout(() => cargarDetalleTexto(idTexto), 1500);
              })
              .catch(error => {
                mostrarError('Error al crear texto: \n' + error.message);
              });
    });
  }

  // Construir formulario para editar texto.
  function mostrarFormularioEdicion(idTexto) {
    // Seteamos flags.
    instanciaAnterior = instanciaActual;
    instanciaActual   = 'formulario';

    document.getElementById('filtrosContainer').style.display = 'none';
    fetch(`${BASE_URL}/texto/${idTexto}`)
            .then(response => response.json())
            .then(texto => {
              const container = document.getElementById('resultadosContainer');
              container.style.background = '#f2eded';

              // Determinar opciones de estado disponibles
              let opcionesEstado = '';
              if (texto.estado === 'BORRADOR') {
                opcionesEstado = `
                    <option value="BORRADOR" selected>Borrador</option>
                    <option value="PUBLICADO">Publicar</option>
                `;
              } else if (texto.estado === 'PUBLICADO') {
                opcionesEstado = `<option value="PUBLICADO" selected>Publicado (no editable)</option>`;
              } else { // Estado OCULTO (solo para admins)
                opcionesEstado = `<option value="${texto.estado}" selected>Estado actual: ${texto.estado}</option>`;
              }

              container.innerHTML = `
                <div class="form-header">
                    <button class="btn-volver-form" onclick="volver()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <i class="fas fa-edit"></i> Editar Texto
                </div>
                <div class="form-crear-container">
                    <div class="form-inner-wrapper">
                        <form id="editarTextoForm">
                            <input type="hidden" id="idTexto" name="idTexto" value="${texto.idTexto}">

                            <div class="form-group">
                                <label for="titulo">Título:</label>
                                <input type="text" id="titulo" name="titulo" value="${texto.titulo || ''}" required>
                            </div>

                            <div class="form-group">
                                <label for="contenido">Contenido:</label>
                                <textarea id="contenido" name="contenido" required>${texto.contenido || ''}</textarea>
                            </div>

                            <div class="form-dual-select">
                                <div class="form-group">
                                    <label for="estado">Estado:</label>
                                    <select id="estado" name="estado" required
                                            ${texto.estado === 'PUBLICADO' ? 'disabled' : ''}>
                                        ${opcionesEstado}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="idioma">Idioma:</label>
                                    <input type="text" id="idioma" name="idioma" value="${texto.idioma || ''}">
                                </div>
                            </div>

                            <div class="form-dual-select">
                                <div class="form-group">
                                    <label>Categoría:</label>
                                    <select id="categoria" name="categoria" required>
                                        <option value="MISTERIO" ${texto.categoria?.categoria === 'MISTERIO' ? 'selected' : ''}>Misterio</option>
                                        <option value="THRILLER" ${texto.categoria?.categoria === 'THRILLER' ? 'selected' : ''}>Thriller</option>
                                        <option value="DRAMA" ${texto.categoria?.categoria === 'DRAMA' ? 'selected' : ''}>Drama</option>
                                        <option value="FANTASIA" ${texto.categoria?.categoria === 'FANTASIA' ? 'selected' : ''}>Fantasía</option>
                                        <option value="CIENCIAFIC" ${texto.categoria?.categoria === 'CIENCIAFIC' ? 'selected' : ''}>Ciencia Ficción</option>
                                        <option value="HISTORICO" ${texto.categoria?.categoria === 'HISTORICO' ? 'selected' : ''}>Histórico</option>
                                        <option value="AVENTURA" ${texto.categoria?.categoria === 'AVENTURA' ? 'selected' : ''}>Aventura</option>
                                        <option value="FANFIC" ${texto.categoria?.categoria === 'FANFIC' ? 'selected' : ''}>Fanfic</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Subcategoría:</label>
                                    <select id="subcategoria" name="subcategoria">
                                        <option value="">Ninguna</option>
                                        <option value="CRIMEN" ${texto.categoria?.subcategoria === 'CRIMEN' ? 'selected' : ''}>Crimen</option>
                                        <option value="POLICIACO" ${texto.categoria?.subcategoria === 'POLICIACO' ? 'selected' : ''}>Policiaco</option>
                                        <option value="ROMANCE" ${texto.categoria?.subcategoria === 'ROMANCE' ? 'selected' : ''}>Romance</option>
                                        <option value="PSICOLOGICO" ${texto.categoria?.subcategoria === 'PSICOLOGICO' ? 'selected' : ''}>Psicológico</option>
                                        <option value="CONSPIRACION" ${texto.categoria?.subcategoria === 'CONSPIRACION' ? 'selected' : ''}>Conspiración</option>
                                        <option value="FUTURISTA" ${texto.categoria?.subcategoria === 'FUTURISTA' ? 'selected' : ''}>Futurista</option>
                                        <option value="TERROR" ${texto.categoria?.subcategoria === 'TERROR' ? 'selected' : ''}>Terror</option>
                                        <option value="PARANORMAL" ${texto.categoria?.subcategoria === 'PARANORMAL' ? 'selected' : ''}>Paranormal</option>
                                        <option value="JUVENIL" ${texto.categoria?.subcategoria === 'JUVENIL' ? 'selected' : ''}>Juvenil</option>
                                        <option value="UTOPIA" ${texto.categoria?.subcategoria === 'UTOPIA' ? 'selected' : ''}>Utopía</option>
                                        <option value="DISTOPIA" ${texto.categoria?.subcategoria === 'DISTOPIA' ? 'selected' : ''}>Distopía</option>
                                        <option value="BELICO" ${texto.categoria?.subcategoria === 'BELICO' ? 'selected' : ''}>Bélico</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="sinopsis">Sinopsis:</label>
                                <textarea id="sinopsis" name="sinopsis">${texto.sinopsis || ''}</textarea>
                            </div>

                            <button type="submit" class="btn-submit">Actualizar Texto</button>
                        </form>
                    </div>
                </div>
            `;

              configurarFormularioEdicion(texto.estado);
            })
            .catch(error => mostrarError('No se pudo cargar el texto para edición'));
  }

  function configurarFormularioEdicion(estadoActual) {
    document.getElementById('editarTextoForm')?.addEventListener('submit', function(e) {
      e.preventDefault();

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());
      const idTexto = data.idTexto;

      // Si el estado era PUBLICADO, mantenerlo fijo
      if (estadoActual === 'PUBLICADO') {
        data.estado = 'PUBLICADO';
      }

      // Limpiar valores vacíos
      if (data.subcategoria === "") data.subcategoria = null;

      const params = new URLSearchParams();
      for (const key in data) {
        if (data[key]) params.append(key, data[key]);
      }

      fetch(`${BASE_URL}/texto/${idTexto}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
      })
              .then(response => {
                if (!response.ok) throw new Error('Error en la actualización');
                return response.json();
              })
              .then(textoActualizado => {
                mostrarFeedback('Texto actualizado correctamente');
                setTimeout(() => cargarDetalleTexto(idTexto), 1500);
              })
              .catch(error => {
                mostrarError('Error al actualizar: ' + error.message);
              });
    });
  }

  // Sistema de puntuación.
  let formularioPuntuacionVisible = false;

  function mostrarFormPuntuacion() {
    const form = document.getElementById('puntuacionForm');
    form.style.display = formularioPuntuacionVisible ? 'none' : 'flex';
    formularioPuntuacionVisible = !formularioPuntuacionVisible;

    if (formularioPuntuacionVisible) {
      form.querySelector('input').focus();
    }
  }

  function configurarPuntuacion(idTexto) {
    const form = document.getElementById('puntuacionForm');
    const input = form.querySelector('input');

    form.onsubmit = function(e) {
      e.preventDefault();
      enviarPuntuacion(idTexto, input.value);
    };
  }

  // Enviar puntuación.
  function enviarPuntuacion(idTexto, nota) {
    const idUsuario = usuarioActual.idUsuario;

    if (!nota || nota < 1 || nota > 10) {
      mostrarError('La nota debe estar entre 1 y 10');
      return;
    }

    fetch(`${BASE_URL}/texto/${idTexto}/nota/${idUsuario}?nota=${nota}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
    })
            .then(response => {
              if (!response.ok) throw new Error('Error al enviar puntuación');
              return response.json();
            })
            .then(notaTexto => {
              // Actualizar la nota media
              document.querySelector('.detalle-relato-nota').textContent =
                      notaTexto.texto.notaMedia.toFixed(1);
              mostrarFormPuntuacion();
              mostrarFeedback('Puntuación registrada.');
              setTimeout(() => cargarDetalleTexto(idTexto), 1500);
            })
            .catch(error => {
              mostrarError(error.message);
              mostrarFormPuntuacion();
            });
  }

  // Asegura la carga de cualquier perfil.
  function cargarPerfilUsuario(idUsuario) {
    if (usuarioActual == null) {
      fetch(`${BASE_URL}/usuario/${idUsuario}/mostrar`)
              .then(response => {
                if (!response.ok) throw new Error('Usuario no encontrado');
                return response.json();
              })
              .then(usuario => mostrarPerfilUsuario(usuario))
              .catch(error => mostrarError(error.message));
    } else if (usuarioActual && usuarioActual.idUsuario === idUsuario) {
      mostrarPerfilUsuario(usuarioActual);
    } else {
      fetch(`${BASE_URL}/usuario/${idUsuario}/mostrar`)
              .then(response => {
                if (!response.ok) throw new Error('Usuario no encontrado');
                return response.json();
              })
              .then(usuario => mostrarPerfilUsuario(usuario))
              .catch(error => mostrarError(error.message));
    }
  }

  // Cargar el perfil de usuarioActual.
  async function mostrarPerfilUsuario(usuario) {
    // Seteamos flags.
    instanciaAnterior = instanciaActual;
    instanciaActual  = 'perfil';
    ultimoPerfilVisitado = usuario.idUsuario;

    // Ocultamos sistema de filtros.
    document.getElementById('filtrosContainer').style.display = 'none';

    const container = document.getElementById('resultadosContainer');
    container.style.background = '#f2eded';
    // Plantilla perfil.
    container.innerHTML = `
        <div class="form-header">
            <button class="btn-volver-form" onclick="volver()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <i class="fas fa-user"></i>Perfil de usuario
            <div id="btnSeguirContainer"></div>
        </div>
        <div class="form-crear-container">
            <div class="perfil-wrapper">
                <div class="columna-izq">
                    <div class="info-usuario">
                        <div class="contacto-avatar grande">
                            ${usuario.avatarURL
                              ? `<img src="${usuario.avatarURL}" alt="Avatar de ${usuario.alias}" class="avatar-img">`
                              : `<i class="fas fa-user"></i>`
                            }
                        </div>
                        <div class="perfil-info">
                            <span>${usuario.nombre} ${usuario.apellido}</span>
                            <div class="detalle-email">${usuario.email}</div>
                        </div>
                    </div>
                    <div class="contactos-wrapper">
                    <h3 class="titulo-seccion">
                        Seguidos (<span id="numContactos">0</span>):
                    </h3>
                    <div class="lista-contactos" id="listaContactos"></div>
                    </div>
                </div>

                <div class="columna-der">
                    <h3 class="titulo-seccion">Relatos (<span id="numTextos">0</span>):</h3>
                    <div class="lista-textos" id="listaTextos"></div>
                </div>
            </div>
        </div>`;
        // Cargar datos
        cargarContactos(usuario);
        cargarTextosUsuario(usuario);

        // Si no hay sesión o es tu propio perfil, no metemos botón
        if (!usuarioActual || usuarioActual.idUsuario === usuario.idUsuario) {
          return;
        }

        // 3) Montar botón Seguir / Dejar de seguir
        await montarBotonSeguir(usuario.idUsuario);
  }

  async function montarBotonSeguir(idSeguido) {
    const contenedor = document.getElementById('btnSeguirContainer');
    contenedor.innerHTML = ''; // Limpia contenedor.

    let seguidos;
    try {
      const resp = await fetch(`${BASE_URL}/siguiendo?idUsuario=${usuarioActual.idUsuario}`);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      seguidos = await resp.json();
    } catch (e) {
      console.error('Error comprobando seguidos', e);
      return;
    }

    const yaSeguido = seguidos.some(u => u.idUsuario === idSeguido);
    const btn = document.createElement('button');
    btn.id = 'btnSeguir';
    btn.textContent = yaSeguido ? 'Dejar de seguir' : 'Seguir';
    btn.className = yaSeguido ? 'btnSeguir' : 'btnSeguir';

    btn.onclick = async () => {
      try {
        const url = yaSeguido
                ? `${BASE_URL}/dejarDeSeguir?idSeguidor=${usuarioActual.idUsuario}&idSeguido=${idSeguido}`
                : `${BASE_URL}/seguir?idSeguidor=${usuarioActual.idUsuario}&idSeguido=${idSeguido}`;
        const method = yaSeguido ? 'DELETE' : 'POST';

        const resp = await fetch(url, { method });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        // Vuelve a cargar todo el perfil (actualiza lista y botón)
        cargarPerfilUsuario(idSeguido);
      } catch (err) {
        alert(`Error al ${yaSeguido ? 'dejar de seguir' : 'seguir'}: ${err.message}`);
      }
    };

    contenedor.appendChild(btn);
  }

  function cargarContactos(usuario) {
    fetch(`${BASE_URL}/siguiendo?idUsuario=${usuario.idUsuario}`)
      .then(resp => {
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return resp.json();
      })
      .then(contactos => {
        mostrarContactos(contactos);
        document.getElementById('numContactos').textContent = contactos.length;
      })
      .catch(error => mostrarError('Error cargando contactos: ' + error.message));
  }

  // Mostrar contactos de usuarioActual.
  function mostrarContactos(contactos) {
    const lista = document.getElementById('listaContactos');
    if (!contactos || contactos.length === 0) {
      lista.innerHTML = '<div class="sin-contactos">No tienes contactos aún</div>';
      return;
    }

    lista.innerHTML = contactos.map(contacto => `
        <div class="contacto-card">
            <div class="contacto-info">
                <div class="contacto-nombre">
                    <i class="fas fa-user contacto-icono"></i>
                    <span>${contacto.nombre} ${contacto.apellido}</span>
                </div>
            </div>
        </div>
    `).join('');
  }

  // Nueva función para cargar textos del usuario
  function cargarTextosUsuario(usuario) {
    fetch(`${BASE_URL}/usuario/${usuario.idUsuario}/textos`)
            .then(resp => resp.json())
            .then(textos => {
               mostrarTextosUsuario(textos);
               document.getElementById('numTextos').textContent = textos.length || 0;
            })
            .catch(error => console.error('Error:', error));
  }

  function mostrarTextosUsuario(textos) {
    const container = document.getElementById('listaTextos');

    if (!textos || textos.length === 0) {
      container.innerHTML = '<div class="sin-datos">No hay textos publicados.</div>';
      return;
    }

    container.innerHTML = textos.map(texto => `
        <div class="texto-item" onclick="cargarDetalleTexto(${texto.idTexto})">
            <div class="texto-titulo">
                <span class="titulo">${texto.titulo}</span>
                <span class="texto-fecha">${formatearFecha(texto.fechaPublicacion)}</span>
            </div>
        </div>
    `).join('');
  }

  document.addEventListener('DOMContentLoaded', function() {
    const idTexto = getParameterByName('idTexto');

    obtenerUsuarioActual();
    cargarLogin();

    // Cargar categorías siempre.
    fetch(`${BASE_URL}/categorias/subcategorias`)
            .then(resp => resp.json())
            .then(data => {
              const categorias = data.categorias || [];
              const select = document.getElementById('categoriaSelect');
              categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
              });
            })
            .catch(err => { /* Nada, deja el select vacío */ });

    if (idTexto) {
      cargarDetalleTexto(idTexto)
              .catch(() => {
                // Fallback a lista si falla.
                cargarTextosPorDefecto();
              });
    } else {
      cargarTextosPorDefecto();
    }
  });

  function cargarTextosPorDefecto() {
    // Cargar textos por defecto.
    fetch(`${BASE_URL}/textos?criterio=fechaPublicacionD`)
            .then(resp => resp.json())
            .then(initPaginacion);
  }
</script>
</body>
</html>