<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Cliente</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        form { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
        h2 { margin-top: 0; }
        label { display: inline-block; width: 200px; }
        input, textarea, select { width: 300px; }
        button { margin-top: 10px; }
    </style>
</head>
<body>
<h1>Panel Cliente</h1>

<!-- Buscar Usuarios -->
<form id="buscarUsuariosForm">
    <h2>Buscar Usuarios</h2>
    <label for="subcadenaUsuarios">Nombre o parte del nombre:</label>
    <input type="text" id="subcadenaUsuarios" name="subcadena" placeholder="Ingresa subcadena" required>
    <button type="submit">Buscar Usuarios</button>
</form>

<!-- Buscar Textos -->
<form id="buscarTextosForm">
    <h2>Buscar Textos</h2>
    <label for="subcadenaTextos">Título o contenido:</label>
    <input type="text" id="subcadenaTextos" name="subcadena" placeholder="Ingresa subcadena" required>
    <button type="submit">Buscar Textos</button>
</form>

<!-- Crear Usuario -->
<form id="crearUsuarioForm">
    <h2>Crear Usuario</h2>
    <label for="nombre">Nombre:</label>
    <input type="text" id="nombre" name="nombre" required><br>

    <label for="apellido">Apellido:</label>
    <input type="text" id="apellido" name="apellido" required><br>

    <label for="alias">Alias:</label>
    <input type="text" id="alias" name="alias"><br>

    <label for="email">Email:</label>
    <input type="email" id="email" name="email" required><br>

    <label for="password">Password:</label>
    <input type="password" id="password" name="password" required><br>

    <label for="fechaNac">Fecha de Nacimiento (yyyy-MM-dd):</label>
    <input type="text" id="fechaNac" name="fechaNac" required><br>

    <button type="submit">Crear Usuario</button>
</form>

<!-- Actualizar Usuario -->
<form id="actualizarUsuarioForm">
    <h2>Actualizar Usuario</h2>
    <label for="idUsuarioUpdate">ID Usuario:</label>
    <input type="number" id="idUsuarioUpdate" name="idUsuario" required><br>

    <label for="aliasUpdate">Nuevo Alias:</label>
    <input type="text" id="aliasUpdate" name="alias"><br>

    <label for="emailUpdate">Nuevo Email:</label>
    <input type="email" id="emailUpdate" name="email"><br>

    <label for="passwordUpdate">Nueva Password:</label>
    <input type="password" id="passwordUpdate" name="password"><br>

    <label for="fechaNacUpdate">Nueva Fecha de Nac (yyyy-MM-dd):</label>
    <input type="text" id="fechaNacUpdate" name="fechaNac"><br>

    <label for="sexoUpdate">Sexo:</label>
    <input type="text" id="sexoUpdate" name="sexo"><br>

    <label for="ciudadUpdate">Ciudad:</label>
    <input type="text" id="ciudadUpdate" name="ciudad"><br>

    <label for="avatarURLUpdate">Avatar URL:</label>
    <input type="text" id="avatarURLUpdate" name="avatarURL"><br>

    <button type="submit">Actualizar Usuario</button>
</form>

<!-- Eliminar Usuario (Borrado Blando) -->
<form id="eliminarUsuarioForm">
    <h2>Eliminar Usuario</h2>
    <label for="idUsuarioDelete">ID Usuario:</label>
    <input type="number" id="idUsuarioDelete" name="idUsuario" required><br>

    <button type="submit">Eliminar Usuario</button>
</form>

<!-- Crear Texto -->
<form id="crearTextoForm">
    <h2>Crear Texto</h2>
    <label for="idAutor">ID Autor:</label>
    <input type="number" id="idAutor" name="idAutor" required><br>

    <label for="titulo">Título:</label>
    <input type="text" id="titulo" name="titulo" required><br>

    <label for="contenido">Contenido:</label>
    <textarea id="contenido" name="contenido" required></textarea><br>

    <label for="estado">Estado:</label>
    <input type="text" id="estado" name="estado" required><br>

    <!-- Combobox para Categoría -->
    <div>
        <label>Categoría:</label>
        <select id="categoria" name="categoria">
            <!-- Opciones se llenan con JavaScript -->
        </select>
    </div>

    <!-- Combobox para Subcategoría -->
    <div>
        <label>Subcategoría (opcional):</label>
        <select id="subcategoria" name="subcategoria">
            <!-- Opciones se llenan con JavaScript -->
        </select>
    </div>

    <label for="idioma">Idioma:</label>
    <input type="text" id="idioma" name="idioma"><br>

    <label for="sinopsis">Sinopsis:</label>
    <textarea id="sinopsis" name="sinopsis"></textarea><br>

    <button type="submit">Crear Texto</button>
</form>

<!-- Actualizar Texto -->
<form id="actualizarTextoForm">
    <h2>Actualizar Texto</h2>
    <label for="idTextoUpdate">ID Texto:</label>
    <input type="number" id="idTextoUpdate" name="idTexto" required><br>

    <label for="tituloUpdate">Nuevo Título:</label>
    <input type="text" id="tituloUpdate" name="titulo"><br>

    <label for="estadoUpdate">Nuevo Estado:</label>
    <input type="text" id="estadoUpdate" name="estado"><br>

    <label for="categoriaUpdate">Categoría:</label>
    <input type="text" id="categoriaUpdate" name="categoria"><br>

    <label for="subcategoriaUpdate">Subcategoría:</label>
    <input type="text" id="subcategoriaUpdate" name="subcategoria"><br>

    <label for="idiomaUpdate">Idioma:</label>
    <input type="text" id="idiomaUpdate" name="idioma"><br>

    <label for="sinopsisUpdate">Sinopsis:</label>
    <textarea id="sinopsisUpdate" name="sinopsis"></textarea><br>

    <label for="contenidoUpdate">Nuevo Contenido:</label>
    <textarea id="contenidoUpdate" name="contenido"></textarea><br>

    <button type="submit">Actualizar Texto</button>
</form>

<form id="formPuntuarTexto">
    <h2>Puntuar texto</h2>
    <label for="idTextoNota">ID del texto:</label>
    <input type="number" id="idTextoNota" name="idTextoNota" required min="1"><br>

    <label for="idUsuario">ID del usuario:</label>
    <input type="number" id="idUsuario" name="idUsuario" required min="1"><br>

    <label for="nota">Nota (1-10):</label>
    <input type="number" id="nota" name="nota" required min="1" max="10" step="0.1"><br>

    <button type="submit">Puntuar</button>
</form>

<!-- Eliminar Texto -->
<form id="eliminarTextoForm">
    <h2>Eliminar Texto</h2>
    <label for="idTextoDelete">ID Texto:</label>
    <input type="number" id="idTextoDelete" name="idTexto" required><br>

    <button type="submit">Eliminar Texto</button>
</form>

<!-- Crear mensaje -->
<form id="crearMensajeForm">
    <h2>Crear comentario</h2>
    <label for="contenidoStr">Contenido:</label>
    <textarea id="contenidoStr" name="contenidoStr" required></textarea><br>

    <label for="idEmisor">ID Emisor:</label>
    <input type="number" id="idEmisor" name="idEmisor" required><br>

    <label for="tipoStr">Tipo:</label>
    <select id="tipoStr" name="tipoStr" required>
        <option value="COMENTARIO">Comentario</option>
        <option value="RESCOMENTARIO">Respuesta a comentario</option>
        <option value="PRIVADO">Privado</option>
        <option value="RESPRIVADO">Respuesta privada</option>
    </select><br>

    <label for="idTexto">ID Texto (si aplica):</label>
    <input type="number" id="idTexto" name="idTexto"><br>

    <label for="idPadre">ID Mensaje Padre (si aplica):</label>
    <input type="number" id="idPadre" name="idPadre"><br>

    <label for="idReceptor">ID Receptor (para privados):</label>
    <input type="number" id="idReceptor" name="idReceptor"><br>

    <button type="submit">Crear Mensaje</button>
</form>

<form id="formActualizarMensaje">
    <h2>Actualizar mensaje</h2>
    <label for="idMensaje">ID del mensaje:</label>
    <input type="number" id="idMensaje" name="idMensaje" required min="1"><br>

    <label for="contenidoMsg">Nuevo contenido:</label>
    <textarea id="contenidoMsg" name="contenidoMsg" required></textarea><br>

    <button type="submit">Actualizar mensaje</button>
</form>

<form id="formEliminarMensaje">
    <h2>Eliminar mensaje</h2>
    <label for="idMensajeEliminar">ID del mensaje:</label>
    <input type="number" id="idMensajeEliminar" name="idMensajeEliminar" required min="1"><br>
    <button type="submit">Eliminar mensaje</button>
</form>

<form id="formSolicitarContacto">
    <h2>Agregar contacto</h2>
    <input type="number" name="idUsuario1" placeholder="ID Usuario 1" required>
    <input type="number" name="idUsuario2" placeholder="ID Usuario 2" required>
    <button type="submit">Solicitar</button>
</form>

<form id="formListarContactos">
    <h2>Listar contactos</h2>
    <input type="number" name="idUsuario" placeholder="ID Usuario" required>
    <input type="text" name="estado" placeholder="Estado (ACEPTADO, PENDIENTE...)" value="ACEPTADO">
    <button type="submit">Listar</button>
</form>

<form id="formAceptarContacto">
    <h2>Aceptar contacto</h2>
    <input type="number" name="idUsuario1" placeholder="ID Usuario 1 (aceptante)" required>
    <input type="number" name="idUsuario2" placeholder="ID Usuario 2 (solicitó)" required>
    <button type="submit">Aceptar</button>
</form>

<form id="formEliminarContacto">
    <h2>Eliminar contacto</h2>
    <input type="number" name="idUsuario1" placeholder="ID Usuario 1" required>
    <input type="number" name="idUsuario2" placeholder="ID Usuario 2" required>
    <button type="submit">Eliminar</button>
</form>

<form id="formBloquearContacto">
    <h2>Bloquear contacto</h2>
    <input type="number" name="idUsuario1" placeholder="ID Usuario que bloquea" required>
    <input type="number" name="idUsuario2" placeholder="ID Usuario a bloquear" required>
    <button type="submit">Bloquear</button>
</form>

<div id="respuestaActualizarMensaje"></div>

<!-- Resultados -->
<h2>Resultados:</h2>
<ul id="resultados"></ul>

<script>
    const BASE_URL = 'http://localhost:8080';

    // Función para mostrar resultados en pantalla.
    function mostrarResultados(data) {
        const lista = document.getElementById('resultados');
        lista.innerHTML = ''; // Limpiar resultados anteriores.

        if (Array.isArray(data)) {
            data.forEach(item => {
                const li = document.createElement('li');
                li.textContent = JSON.stringify(item, null, 2);
                lista.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.textContent = JSON.stringify(data, null, 2);
            lista.appendChild(li);
        }
    }

    // Buscar usuarios por subcadena.
    document.getElementById('buscarUsuariosForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const subcadena = document.getElementById('subcadenaUsuarios').value;

        fetch(`${BASE_URL}/admin/usuarios/buscar?subcadena=${encodeURIComponent(subcadena)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('No se han encontrado usuarios.');
                }
                return response.json();
            })
            .then(data => {
                mostrarResultados(data);
                this.reset(); // Opcional: limpiar el formulario.
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al buscar usuarios: \n' + error.message);
            });
    });

    // Buscar textos por subcadena.
    document.getElementById('buscarTextosForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const subcadena = document.getElementById('subcadenaTextos').value.trim();

        fetch(`${BASE_URL}/textos?subcadena=${encodeURIComponent(subcadena)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('No se encontraron coincidencias.');
                }
                return response.json();
            })
            .then(data => {
                mostrarResultados(data);
                this.reset(); // Limpia el formulario.
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al buscar textos: \n' + error.message);
            });
    });

    // Crear Usuario.
    document.getElementById('crearUsuarioForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new URLSearchParams(new FormData(this));

        fetch(`${BASE_URL}/usuario/crear`, {
            method: 'POST',
            body: formData // ¡Los datos van aquí, en el objeto de configuración!
        })
            .then(response => { // ¡Aquí empiezan las promesas!
                if (!response.ok) {
                    // Si la respuesta no es OK, leer el texto del error
                    return response.text().then(text => {
                        throw new Error(text); // Lanzar el error para el catch
                    });
                }
                return response.json(); // Si es OK, parsear como JSON
            })
            .then(data => {
                alert('Usuario creado con éxito.');
                mostrarResultados(data);
                this.reset();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al crear usuario: \n' + error.message);
            });
    });

    // Actualizar Usuario
    document.getElementById('actualizarUsuarioForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new URLSearchParams(new FormData(this));

        fetch(`${BASE_URL}/usuario/actualizar`, {
            method: 'PUT',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                alert('Usuario actualizado con éxito.');
                mostrarResultados(data);
                this.reset();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al actualizar usuario: \n' + error.message);
            });
    });

    // Eliminar Usuario
    document.getElementById('eliminarUsuarioForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const idUsuario = document.getElementById('idUsuarioDelete').value;

        fetch(`${BASE_URL}/usuario/${idUsuario}`, {
            method: 'PUT'
        })
            .then(response => response.text())
            .then(message => {
                alert(message);
                this.reset();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar usuario: \n' + error.message);
            });
    });

    // Cargar categorías y subcategorías al iniciar la página
    document.addEventListener("DOMContentLoaded", function() {
        fetch(`${BASE_URL}/categorias/subcategorias`)
            .then(response => response.json())
            .then(data => {
                const categoriaSelect = document.getElementById("categoria");
                const subcategoriaSelect = document.getElementById("subcategoria");

                // Llenar categorías
                data.categorias.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat;
                    option.textContent = cat;
                    categoriaSelect.appendChild(option);
                });

                // Llenar subcategorías con "Opcional" como primera opción
                const opcionalOption = document.createElement("option");
                opcionalOption.value = "";
                opcionalOption.textContent = "Opcional";
                subcategoriaSelect.appendChild(opcionalOption);

                data.subcategorias.forEach(subCat => {
                    const option = document.createElement("option");
                    option.value = subCat;
                    option.textContent = subCat;
                    subcategoriaSelect.appendChild(option);
                });
            })
            .catch(error => console.error("Error cargando categorías:", error));
    });

    // Manejar envío del formulario de texto
    document.getElementById("crearTextoForm").addEventListener("submit", function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        // Convertir subcategoría vacía a null.
        if (data.subcategoria === "Opcional") {
            data.subcategoria = null;
        }

        // Convertir a URLSearchParams (para enviar como x-www-form-urlencoded)
        const params = new URLSearchParams();
        for (const key in data) {
            params.append(key, data[key]);
        }

        // Enviar datos al backend
        fetch(`${BASE_URL}/texto`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: params
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(resultado => {
                alert("Texto creado con ID: " + resultado.idTexto);
                this.reset(); // Limpiar el formulario
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error al crear texto: \n" + error.message);
            });
    });

    // Crear Texto
    /*document.getElementById('crearTextoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new URLSearchParams(new FormData(this));

        // Convierte subcategoría vacía a null.
        if (data.subcategoria === "") {
            data.subcategoria = null;
        }

        fetch(`${BASE_URL}/texto/crear`, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                alert('Texto creado con éxito.');
                mostrarResultados(data);
                this.reset();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al crear texto: \n' + error.message);
            });
    });*/

    // Actualizar Texto.
    document.getElementById('actualizarTextoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = new FormData(this);
        const id = form.get('idTexto');
        const params = new URLSearchParams(form).toString();

        fetch(`${BASE_URL}/texto/${id}?${params}`, {
            method: 'PUT'
            // No necesitas headers ni body aquí
        })
            .then(response => response.json())
            .then(data => {
                alert('Texto actualizado con éxito.');
                mostrarResultados(data);
                this.reset();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al actualizar texto: \n' + error.message);
            });
    });

    document.getElementById('formPuntuarTexto').addEventListener('submit', function(e) {
        e.preventDefault();

        // Recoger valores del formulario
        const idTexto = document.getElementById('idTextoNota').value;
        const idUsuario = document.getElementById('idUsuario').value;
        const nota = document.getElementById('nota').value;

        // Construir la URL del endpoint
        const url = `/texto/${idTexto}/nota/${idUsuario}?nota=${encodeURIComponent(nota)}`;

        fetch(url, {
            method: 'PUT'
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('resultados').innerHTML =
                    `<p>Puntuación guardada correctamente. Nota: <strong>${data.nota}</strong></p>`;
            })
            .catch(error => {
                document.getElementById('resultados').innerHTML =
                    `<p style="color:red;">Error: ${error.message}</p>`;
            });
    });

    // Crear mensaje.
    document.getElementById('crearMensajeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new URLSearchParams(new FormData(this));

        fetch(`${BASE_URL}/mensaje`, {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(data => {
                alert('Mensaje creado con éxito.');
                mostrarResultados(data);
                this.reset();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al crear mensaje: \n' + error.message);
            });
    });

    document.getElementById('formActualizarMensaje').addEventListener('submit', function(e) {
        e.preventDefault();

        const idMensaje = document.getElementById('idMensaje').value;
        const contenidoMsg = document.getElementById('contenidoMsg').value;

        const url = `${BASE_URL}/mensaje/${idMensaje}?contenidoStr=${encodeURIComponent(contenidoMsg)}`;
        fetch(url, {
            method: 'PUT'
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(data => {
                mostrarResultados(data);
            })
            .catch(error => {
                // Puedes mostrar el error en la lista de resultados o con alert
                mostrarResultados({ error: error.message });
                // alert('Error al actualizar mensaje: \n' + error.message);
            });
    });

    // Eliminar Texto.
    document.getElementById('eliminarTextoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('idTextoDelete').value;

        fetch(`${BASE_URL}/texto/${id}/eliminar`, {
            method: 'PUT'
        })
            .then(response => response.text())
            .then(message => {
                alert(message);
                this.reset();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar texto: \n' + error.message);
            });
    });

    document.getElementById('formEliminarMensaje').addEventListener('submit', function(e) {
        e.preventDefault();

        const idMensaje = document.getElementById('idMensajeEliminar').value;
        const url = `${BASE_URL}/mensaje/${idMensaje}/eliminar`;

        fetch(url, {
            method: 'PUT'
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.text();
            })
            .then(data => {
                mostrarResultados({ mensaje: data }); // Muestra el mensaje de éxito
                this.reset();
            })
            .catch(error => {
                mostrarResultados({ error: error.message });
            });
    });

    // Agregar contacto.
    document.getElementById('formSolicitarContacto').onsubmit = async function(e) {
        e.preventDefault();
        const fd = new FormData(e.target);
        const params = new URLSearchParams(fd);
        const respuesta = await fetch('/contacto', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        });
        mostrarResultados(await respuesta.json());
    };

    // Listar contactos (ACEPTADOS o PENDIENTES).
    document.getElementById('formListarContactos').onsubmit = async function(e) {
        e.preventDefault();
        const fd = new FormData(e.target);
        const params = new URLSearchParams(fd);
        const respuesta = await fetch('/contactos?' + params, { method: 'GET' });
        mostrarResultados(await respuesta.json());
    };

    // Aceptar contacto.
    document.getElementById('formAceptarContacto').onsubmit = async function(e) {
        e.preventDefault();
        const fd = new FormData(e.target);
        const params = new URLSearchParams(fd);
        const respuesta = await fetch('/contacto/aceptar', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        });
        mostrarResultados(await respuesta.text());
    };

    // Eliminar contacto.
    document.getElementById('formEliminarContacto').onsubmit = async function(e) {
        e.preventDefault();
        const fd = new FormData(e.target);
        const params = new URLSearchParams(fd);
        const respuesta = await fetch('/contacto/eliminar', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        });
        mostrarResultados(await respuesta.text());
    };

    // Bloquear contacto.
    document.getElementById('formBloquearContacto').onsubmit = async function(e) {
        e.preventDefault();
        const fd = new FormData(e.target);
        const params = new URLSearchParams(fd);
        const respuesta = await fetch('/contacto/bloquear', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        });
        mostrarResultados(await respuesta.json());
    };
</script>
</body>
</html>